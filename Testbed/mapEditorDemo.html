<!DOCTYPE html>
<html>
	<head>
    	<meta charset='utf-8'/>
    	<title>Cell Example</title>
		<style> canvas{border : 1px solid black} </style>
	</head>
	<body>
		<canvas id='canvas' width='720' height='480'>Canvas</canvas>
		<canvas id="itemcanvas" width="100" height="480" style="position: absolute;  left: 740px; top: 8px;">Canvas</canvas>
		<canvas id="inventorycanvas" width="50" height="480" style="position: absolute;  left: 850px; top: 8px;">Canvas</canvas>
		<script>
		var canvas, ctx;
		var img=[];
		var kCellWidth, kCellHeight;
		var kVerticalMargin = 0, kHorizontalMargin = 0;
		var icanvas=document.getElementById('itemcanvas');
		var ictx=icanvas.getContext('2d');
		var incanvas=document.getElementById('inventorycanvas');
		var inctx=incanvas.getContext('2d');
		var s;
		var imagenumber=0;
		var i;
		var k=0;
		var cursorimg=new Image();
		var rawX, rawY;
		var newX, newY;
		var x,y;
		var listIndex=0;
		var listLength;
		var cellList=[];
		var imagecolliderList=[];
		var colliderList=[];
		var eCellType = {
		    eCellEmpty:0,
		    eCellWall:1,
		    eCellGround:2
		}; 
		var deletesw=false;
		var itemType=new Array();
		itemType[0]=[0,0,0,0,0];
		var jsonText;
		var dragsw=false;
		var inventorysw=false;
		var sw;
		var ms=new Array(5);
		var imagesw;
		var cellfilter=new Array();
		cellfilter[0]="posX";
		cellfilter[1]="posY";
		cellfilter[2]="type";
		cellfilter[3]="item";
		function init() {
		    canvas = document.getElementById('canvas');
		    ctx = canvas.getContext('2d');
		    kCellWidth = kCellHeight = 50;
		    initCells(10,10);
			ctx.save();
			isometricProjection(ctx);
		    updateCells();
			ctx.restore();
		}

		function initCells(numOfX, numOfY) {
		    var xIndex, yIndex;
		    s=numOfX;
			for (yIndex = 0; yIndex < numOfY; yIndex += 1) { 
		        for (xIndex = 0; xIndex < numOfX; xIndex += 1) {
					cellList.push(new Cell(xIndex, yIndex, eCellType.eCellEmpty,itemType[0]));
					colliderList.push(new Collider(xIndex,yIndex,kCellWidth,kCellHeight));
		        }    
		    }
		}
		
		function updateCells() {
		    listLength = cellList.length;
		    for (listIndex, listLength; listIndex < listLength; listIndex += 1) {
				itemType[listIndex]=[0,0,0,0,0];
		        cellList[listIndex].update();
		    }
		}
		function Cell (posX, posY, type, item) {
		    this.init(posX, posY, type, item);
		}
		Cell.prototype.init = function (posX, posY, type, item) {
		    this.posX = posX;
		    this.posY = posY;
		    this.type = type;
			this.item = item;
		};
		Cell.prototype.update = function () {
		    posX=this.posX;
		    posY=this.posY;
		    this.draw(posX,posY);
		};
		function isometricProjection(ctx){
			var vMargin = 0,
				hMargin = 0,
				cWidth = 720,
				cHeight = 480,
				tileSize = kCellWidth,
				tileNum = s,
				sqrt2 = Math.sqrt(2),
				toRadian = Math.PI / 180;
			vMargin = cWidth / 2;
			hMargin = (cHeight - tileSize * (sqrt2 / 2) * tileNum) / 2;
			// change projection to isometric view
			ctx.translate(kVerticalMargin = vMargin, kHorizontalMargin = hMargin);
			ctx.scale(1, 0.5);
			ctx.rotate(45 * toRadian);
		};
		Cell.prototype.draw = function (posX, posY) {
		    ctx.strokeRect(posX * kCellWidth, posY * kCellHeight, kCellWidth, kCellHeight);
		};
		Cell.prototype.fill = function (posX, posY){
			ctx.fillRect(posX * kCellWidth +1 , posY * kCellHeight +1 , kCellWidth-2, kCellHeight-2);
		};
		function Collider(posX,posY,width,height){
		    this.init(posX,posY,width,height);
		}
		Collider.prototype.init=function(posX,posY,width,height){
		    this.posX=posX;
		    this.posY=posY;
		    this.width=width;
		    this.height=height;
		};
		Collider.prototype.isCollided = function (ptX, ptY) {
			var horizontal = (this.posX*this.width < ptX) && ((this.posX + 1)*this.width > ptX),
			vertical = (this.posY*this.height < ptY) && ((this.posY +1)* this.height > ptY);
			result = false;
			if (horizontal && vertical)
			result = true;
			return result;
		};
		function judge(newX,newY)
		{
			for(listIndex=listLength-1;listIndex>=0;listIndex-=1)
			{
				sw=colliderList[listIndex].isCollided(newX,newY);
				if (sw)
				{
					break;
				}
			}
		}
		function imagejudge(x,y)
		{
			for(i=0;i<imagenumber;++i)
			{
				imagesw=imagecolliderList[i].isCollided(x,y);
				if(imagesw)
				{
					break;
				}
			}
		}
		function eventLoaded()
		{
			i=0;
			var xIndex,yIndex;
			for(yIndex=0;yIndex<3;++yIndex)
			{
				for(xIndex=0;xIndex<2;++xIndex)
				{
					imagecolliderList.push(new Collider(xIndex,yIndex,50,50));
					ictx.drawImage(img[imagenumber],imagecolliderList[imagenumber].posX*50,imagecolliderList[imagenumber].posY*50,50,50);
					++imagenumber;
					if (imagenumber==5)
					{
						break;
					}
				}
			}
		}
		init();
		isometricProjection(ctx);
		for(i=0;i<5;++i)
		{
			img[i]=new Image();
		}
		img[1].src="http://www.clker.com/cliparts/9/1/5/2/119498475589498995button-red_benji_park_01.svg.med.png";
		img[0].src="http://www.bcpark.net/imagedb/thumb/2003/0624/1056458885_0.png";
		img[2].src="http://c.ask.nate.com/imgs/qrsi.php/6133257/8214994/1/1/A/wolf2.jpg"
		img[3].src="https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcS7eqCVfNDZ8i8KOBM_s4qphrXF1gCUO97R9AhSjFRPixOhPDnjnA";
		img[4].src="http://terryfoote.com/wp-content/uploads/2010/11/end.png";
		img[4].addEventListener('load',eventLoaded,false);
		cursorimg.src="http://t0.gstatic.com/images?q=tbn:ANd9GcSV3vaos6fcO5fhS096bxqUfjw0hQEBkE_n4FrA44egsLGVtX3I";
		cursorimg.onload=function(e)
		{
			ictx.drawImage(cursorimg,0,150,50,50);
		}
		icanvas.onclick=function(e)
		{
			x=e.offsetX;
			y=e.offsetY;
			imagejudge(x,y);
			if(i<imagenumber)
			{
				dragsw=true;
			}
			else if(x<=50 || (y>=150 && y<=200))
			{
				inventorysw=true;
			}
		}
		canvas.onclick=function(e)
		{
			inctx.clearRect(0,0,50,480);
			deletesw=false;
			rawX=e.offsetX;
			rawY=e.offsetY;
			var sqrt2 = Math.sqrt(2);
			newX =sqrt2/2*rawX + sqrt2*rawY-sqrt2*(kVerticalMargin/2+kHorizontalMargin);
			newY =  -sqrt2/2*rawX+sqrt2*rawY+sqrt2*(kVerticalMargin/2-kHorizontalMargin);
			judge(newX,newY);
			if(listIndex>=0)
			{
				if(dragsw)
				{
					ctx.drawImage(img[i],cellList[listIndex].posX*kCellWidth+5,cellList[listIndex].posY*kCellHeight+5,30,30);
					itemType[listIndex][i]=1;
					cellList[listIndex].item=itemType[listIndex];
				}
				else if(inventorysw)
				{
					for(i=0;i<5;++i)
					{
						if(cellList[listIndex].item[i]==1)
						{
							inctx.drawImage(img[i],0,i*50,50,50);
						}
					}
					deletesw=true;
				}
				else
				{
					++cellList[listIndex].type;
					cellList[listIndex].item=[0,0,0,0,0];
					itemType[listIndex]=[0,0,0,0,0];
					if(cellList[listIndex].type==3)
					{
						cellList[listIndex].type=0;
					}
					switch(cellList[listIndex].type)
					{
						case 0:
						ctx.fillStyle="#FFFFFF";
						Cell.prototype.draw(colliderList[listIndex].posX,colliderList[listIndex].posY);
						Cell.prototype.fill(colliderList[listIndex].posX,colliderList[listIndex].posY);
						break;
						case 1:
						ctx.fillStyle="#8C8C8C";
						Cell.prototype.fill(colliderList[listIndex].posX,colliderList[listIndex].posY);
						break;
						case 2:
						ctx.fillStyle="#22741C";
						Cell.prototype.fill(colliderList[listIndex].posX,colliderList[listIndex].posY);
						break;
					}
				}
			}
			dragsw=false;	
			inventorysw=false;
			jsonText=JSON.stringify(cellList,cellfilter,"\t");
			localStorage.setItem("contents",jsonText);
		}
		incanvas.onclick=function(e)
		{
			if(deletesw)
			{
				sw=false;
				y=Math.floor(e.offsetY/50);
				inctx.clearRect(0,y*50,50,50);
				itemType[listIndex][y]=0;
				cellList[listIndex].item=itemType[listIndex];
				for(i=0;i<5;++i)
				{
					if (cellList[listIndex].item[i]==1)
					{
						sw=true;
						ctx.drawImage(img[i],cellList[listIndex].posX*kCellWidth+5,cellList[listIndex].posY*kCellHeight+5,30,30);
						break;
					}
				}	
				if(!sw)
				{
					switch(cellList[listIndex].type)
					{
						case 0:
						ctx.fillStyle="#FFFFFF";
						Cell.prototype.draw(colliderList[listIndex].posX,colliderList[listIndex].posY);
						Cell.prototype.fill(colliderList[listIndex].posX,colliderList[listIndex].posY);
						break;
						case 1:
						ctx.fillStyle="#8C8C8C";
						Cell.prototype.fill(colliderList[listIndex].posX,colliderList[listIndex].posY);
						break;
						case 2:
						ctx.fillStyle="#22741C";
						Cell.prototype.fill(colliderList[listIndex].posX,colliderList[listIndex].posY);
						break;
					}
				}
			}
		}
	</script>
    </body>
</html>